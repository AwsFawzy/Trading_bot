from flask import Flask, render_template, redirect, url_for, request, flash, jsonify
import os
import logging
import traceback
from datetime import datetime

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆÙ‰ Ø³Ø¬Ù„ Ø§Ù„ØªØµØ­ÙŠØ­
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø·Ù„Ù‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ app
from app.trade_executor import get_open_trades, get_performance_stats
# Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ­Ø¯Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
from app.trading_bot import (
    start_bot, stop_bot, get_bot_status, clean_all_fake_trades,
    execute_manual_trade_cycle, sell_all_trades
)
from app.trading_system import load_trades, clean_fake_trades
from app.capital_manager import get_capital_status, calculate_available_risk_capital
from app.utils import calculate_total_profit
from app.config import (
    BASE_CURRENCY, MAX_ACTIVE_TRADES, TOTAL_RISK_CAPITAL_RATIO,
    RISK_CAPITAL_RATIO, TAKE_PROFIT, STOP_LOSS, DAILY_LOSS_LIMIT,
    TIME_STOP_LOSS_HOURS, MONITOR_INTERVAL_SECONDS, API_KEY, API_SECRET,
    TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID
)
from app.utils import load_json_data, save_json_data, format_timestamp
# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© MEXC Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
from app.exchange_manager import get_current_price, get_all_symbols_24h_data, get_klines, get_account_balance
from app.telegram_notify import generate_daily_report, start_daily_report_timer
# Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© ÙØ­Øµ Ø§Ù„Ø³ÙˆÙ‚
from app.market_scanner import scan_market

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† market_scanner Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
try:
    from app.market_scanner import (
        start_market_scanner, stop_market_scanner, get_trading_opportunities,
        get_watched_symbols, get_symbol_analysis
    )
except ImportError:
    # ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙŠÙ„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    logger.warning("ØªØ¹Ø°Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¶ Ø¯ÙˆØ§Ù„ market_scannerØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙŠÙ„Ø© Ù…Ø¤Ù‚ØªØ©")
    
    def start_market_scanner(interval=300):
        logger.info(f"ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ start_market_scanner Ù…Ø¹ interval={interval}")
        return True
        
    def stop_market_scanner():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ stop_market_scanner")
        return True
        
    def get_trading_opportunities():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_trading_opportunities")
        return []
        
    def get_watched_symbols():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_watched_symbols")
        return ["BTCUSDT", "ETHUSDT", "SOLUSDT", "DOGEUSDT", "MATICUSDT"]
        
    def get_symbol_analysis(symbol):
        logger.info(f"ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_symbol_analysis Ù…Ø¹ symbol={symbol}")
        return {"symbol": symbol, "error": "Ù„Ø§ ØªØªÙˆÙØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„ÙŠÙ‹Ø§"}
# Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØªØ®ØµØµØ©
# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØªØ®ØµØµØ© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
try:
    from app.market_monitor import (
        start_market_monitor, stop_market_monitor, get_latest_opportunities,
        get_best_opportunities, get_opportunity_details, get_market_summary,
        analyze_price_action, MarketOpportunity
    )
except ImportError:
    logger.warning("ØªØ¹Ø°Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ­Ø¯Ø© market_monitorØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙŠÙ„Ø© Ù…Ø¤Ù‚ØªØ©")
    
    def start_market_monitor(interval=300):
        logger.info(f"ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ start_market_monitor Ù…Ø¹ interval={interval}")
        return True
        
    def stop_market_monitor():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ stop_market_monitor")
        return True
        
    def get_latest_opportunities():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_latest_opportunities")
        return []
        
    def get_best_opportunities():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_best_opportunities")
        return []
        
    def get_opportunity_details(symbol):
        logger.info(f"ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_opportunity_details Ù…Ø¹ symbol={symbol}")
        return {"symbol": symbol, "error": "Ù„Ø§ ØªØªÙˆÙØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„ÙŠÙ‹Ø§"}
        
    def get_market_summary():
        logger.info("ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ get_market_summary")
        return {"status": "ØºÙŠØ± Ù…ØªØ§Ø­"}
        
    def analyze_price_action(symbol):
        logger.info(f"ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù€ analyze_price_action Ù…Ø¹ symbol={symbol}")
        return {"symbol": symbol, "error": "Ù„Ø§ ØªØªÙˆÙØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„ÙŠÙ‹Ø§"}
        
    class MarketOpportunity:
        def __init__(self, symbol, price, signal):
            self.symbol = symbol
            self.price = price
            self.signal = signal

# ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger('main')

app = Flask(__name__, template_folder='app/templates', static_folder='app/static')
app.secret_key = os.environ.get("SESSION_SECRET", "crypto_trading_bot_secret_key")

# ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø´Ø­Ø§Øª Jinja Ø§Ù„Ù…Ø®ØµØµØ©
from app.__init__ import init_jinja_filters
init_jinja_filters(app)

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
from app.trading_bot import start_bot, get_bot_status, check_bot_health, BOT_STATUS
if not BOT_STATUS.get('running', False):
    logger.info("ğŸ¤– Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...")
    start_bot()

# Ø¥Ø¶Ø§ÙØ© Ø¢Ù„ÙŠØ© ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¨ÙˆØª
import threading
import time

def bot_watchdog():
    """Ø¢Ù„ÙŠØ© Ø­Ø§Ø±Ø³Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¨ÙˆØª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚Ù"""
    while True:
        try:
            # ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
            bot_status = get_bot_status()
            if not bot_status.get('running', False):
                logger.warning("ğŸ” Ø§ÙƒØªØ´Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ù…ØªÙˆÙ‚ÙØŒ Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...")
                check_bot_health()
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙˆØª: {e}")
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ÙØ­Øµ Ø§Ù„ØªØ§Ù„ÙŠ (ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
        time.sleep(300)

# ØªØ´ØºÙŠÙ„ Ø­Ø§Ø±Ø³ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…
watchdog_thread = threading.Thread(target=bot_watchdog, daemon=True)
watchdog_thread.start()
logger.info("ğŸ”’ ØªÙ… ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙˆØª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„")

import time
from functools import wraps

# Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
dashboard_cache = {
    'last_update': 0,
    'data': None,
    'cache_time': 60  # ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 60 Ø«Ø§Ù†ÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
}

# ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ ØµÙØ­Ø©
page_caches = {
    'settings': {'last_update': 0, 'data': None, 'cache_time': 120},
    'trades': {'last_update': 0, 'data': None, 'cache_time': 60},
    'watched_coins': {'last_update': 0, 'data': None, 'cache_time': 60}
}

def cache_dashboard_data(func):
    """
    Ù…ØºÙ„Ù (decorator) Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    ÙŠÙ‚ÙˆÙ… Ø¨ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„ Ø¹Ù„Ù‰ API
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        current_time = time.time()
        force_refresh = kwargs.get('force_refresh', False)
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø­Ø¯ÙŠØ«Ø© Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ÙƒÙØ§ÙŠØ© ÙˆÙ„ÙŠØ³ Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
        if dashboard_cache['data'] and not force_refresh and current_time - dashboard_cache['last_update'] < dashboard_cache['cache_time']:
            logger.info("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹")
            return dashboard_cache['data']
        
        # ÙˆØ¥Ù„Ø§ØŒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù†ØªÙŠØ¬Ø©
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        old_data = dashboard_cache['data']
        try:
            # Ù†Ø²ÙŠÙ„ force_refresh Ù…Ù† kwargs Ø¥Ø°Ø§ ÙˆØ¬Ø¯
            if 'force_refresh' in kwargs:
                kwargs.pop('force_refresh')
                
            result = func(*args, **kwargs)
            dashboard_cache['data'] = result
            dashboard_cache['last_update'] = current_time
            logger.info("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹")
            return result
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£
            if old_data:
                logger.info("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«")
                return old_data
            # ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù†Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£
            raise
    return wrapper

def cache_page_data(page_name):
    """
    Ù…ØºÙ„Ù (decorator) Ø¹Ø§Ù… Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙŠ ØµÙØ­Ø©
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            cache = page_caches.get(page_name, {'last_update': 0, 'data': None, 'cache_time': 60})
            current_time = time.time()
            force_refresh = kwargs.get('force_refresh', False)
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø¯ÙŠØ«Ø©
            if cache['data'] and not force_refresh and current_time - cache['last_update'] < cache['cache_time']:
                logger.info(f"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª {page_name} Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹")
                return cache['data']
            
            # Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
            old_data = cache['data']
            try:
                # Ù†Ø²ÙŠÙ„ force_refresh Ù…Ù† kwargs Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                if 'force_refresh' in kwargs:
                    kwargs.pop('force_refresh')
                    
                result = func(*args, **kwargs)
                cache['data'] = result
                cache['last_update'] = current_time
                # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ø¹Ø§Ù…Ø©
                page_caches[page_name] = cache
                logger.info(f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª {page_name} ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹")
                return result
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª {page_name}: {e}")
                if old_data:
                    return old_data
                raise
        return wrapper
    return decorator

@cache_dashboard_data
def get_dashboard_data():
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø·Ø±ÙŠÙ‚Ø© ÙØ¹Ø§Ù„Ø© Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    """
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
        bot_status = get_bot_status()
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        trades = bot_status.get('open_trades', [])
        logger.info(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(trades)} ØµÙÙ‚Ø© Ù…ÙØªÙˆØ­Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª")
        
        for trade in trades:
            symbol = trade.get('symbol', '')
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©
            if not symbol:
                continue
                
            # ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if 'quantity' not in trade and 'origQty' in trade:
                trade['quantity'] = trade['origQty']
                
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
            try:
                price = float(trade.get('price', trade.get('entry_price', 0)))
            except (ValueError, TypeError):
                price = 0
                
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø©
            current_price = get_current_price(symbol)
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¦ÙˆÙŠ
            if price and price > 0 and current_price and current_price > 0:
                change_percent = ((current_price - price) / price) * 100
                trade['current_price'] = current_price
                trade['change_percent'] = change_percent
                trade['take_profit_price'] = round(price * (1 + TAKE_PROFIT), 6)
                trade['stop_loss_price'] = round(price * (1 - STOP_LOSS), 6)
            else:
                trade['current_price'] = current_price or 0
                trade['change_percent'] = 0
                trade['take_profit_price'] = price * (1 + TAKE_PROFIT) if price else 0
                trade['stop_loss_price'] = price * (1 - STOP_LOSS) if price else 0
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù…Ù† capital_manager - Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        capital = get_capital_status()
        
        # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
        logger.info(f"Ø±ØµÙŠØ¯ Ø­Ø§Ù„Ø© ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {capital}")

        # ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù‚Ù‚ Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if 'total_profit_dollar' not in capital:
            profit_statistics = calculate_total_profit()
            capital['total_profit_dollar'] = profit_statistics['total_profit_dollar']
            capital['win_rate'] = profit_statistics['win_rate']
            capital['num_closed_trades'] = profit_statistics['num_closed_trades']
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆÙ…Ø³ØªÙ‚Ø±Ø©
        watched_coins_data = []
        try:
            # ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©
            try:
                watched_symbols = get_watched_symbols()
                
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ Ø£Ø¶Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                if watched_symbols:
                    for symbol in watched_symbols[:5]:  # Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Øª ÙÙ‚Ø·
                        try:
                            # Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø©
                            coin_data = {
                                'symbol': symbol,
                                'current_price': get_current_price(symbol) or 0,
                                'trend': 'ØµØ§Ø¹Ø¯',  # Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                'potential_profit': 1.2,  # Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                'change_24h': 0.5  # Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            }
                            watched_coins_data.append(coin_data)
                        except Exception as e:
                            logger.warning(f"ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© {symbol}: {e}")
                            continue
            except Exception as e:
                logger.warning(f"ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: {e}")
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: {e}")
        
        # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
        if not watched_coins_data:
            # Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            # Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            default_coins = ["BTCUSDT", "ETHUSDT", "OPUSDT", "SOLUSDT", "DOGEUSDT"]
            for symbol in default_coins:
                watched_coins_data.append({
                    'symbol': symbol,
                    'current_price': 0,
                    'trend': 'Ù…ØªØ§Ø¨Ø¹Ø©',
                    'potential_profit': 0,
                    'change_24h': 0
                })
        
        # ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ù…ÙˆØ³ ÙˆØ§Ø­Ø¯
        dashboard_data = {
            'trades': trades,
            'performance': bot_status.get('performance', {}),
            'capital': capital,
            'bot_running': bot_status.get('running', False),
            'watched_coins': watched_coins_data  # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        }
        
        return dashboard_data
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: {e}")
        # Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ø£Ùˆ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        last_known_data = dashboard_cache.get('data', {})
        if not last_known_data:
            last_known_data = {
                'trades': [],
                'performance': {},
                'capital': {},
                'bot_running': False,
                'watched_coins': []
            }
        return last_known_data

@app.route('/')
def home():
    """Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"""
    try:
        # Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù† User-Agent Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        user_agent = request.headers.get('User-Agent', '').lower()
        is_mobile = 'mobile' in user_agent or 'android' in user_agent or 'iphone' in user_agent
        
        # Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ù„Ø¹Ø±Ø¶
        watched_coins = [
            {
                'symbol': 'BTCUSDT',
                'current_price': 50000,
                'trend': 'ØµØ§Ø¹Ø¯',
                'potential_profit': 1.5,
                'change_24h': 2.3
            },
            {
                'symbol': 'ETHUSDT',
                'current_price': 3500,
                'trend': 'ØµØ§Ø¹Ø¯',
                'potential_profit': 2.1,
                'change_24h': 3.2
            },
            {
                'symbol': 'OPUSDT',
                'current_price': 25,
                'trend': 'ØµØ§Ø¹Ø¯',
                'potential_profit': 1.9,
                'change_24h': 1.5
            },
            {
                'symbol': 'SOLUSDT',
                'current_price': 150,
                'trend': 'ØµØ§Ø¹Ø¯',
                'potential_profit': 1.2,
                'change_24h': 0.8
            },
            {
                'symbol': 'DOGEUSDT',
                'current_price': 0.12,
                'trend': 'ØµØ§Ø¹Ø¯',
                'potential_profit': 0.9,
                'change_24h': 0.5
            }
        ]
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… - Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙ… Ø«Ø§Ø¨ØªØ©
        try:
            capital = get_capital_status()
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
            if not isinstance(capital, dict):
                capital = {}
                
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ù†ÙˆØ¹ float Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ù€ __round__
            for key in ['total_balance', 'risk_capital', 'per_trade_capital', 'daily_loss', 
                        'daily_loss_limit', 'daily_loss_percent', 'risk_capital_percent',
                        'total_profit_dollar', 'win_rate']:
                if key in capital and capital[key] is not None:
                    try:
                        capital[key] = float(capital[key])
                    except (TypeError, ValueError):
                        capital[key] = 0.0
            
            # Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
            if 'total_profit_dollar' not in capital:
                capital['total_profit_dollar'] = 0.0
            if 'win_rate' not in capital:
                capital['win_rate'] = 0.0
            if 'num_closed_trades' not in capital:
                capital['num_closed_trades'] = 0
                
        except Exception as capital_error:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: {capital_error}")
            # Ù‚Ø§Ù…ÙˆØ³ ÙØ§Ø±Øº Ø¢Ù…Ù† ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£
            capital = {
                'total_balance': 0.0, 'risk_capital': 0.0, 'per_trade_capital': 0.0,
                'daily_loss': 0.0, 'daily_loss_limit': 0.0, 'daily_loss_percent': 0.0,
                'trading_allowed': True, 'risk_capital_percent': 0.0,
                'total_profit_dollar': 0.0, 'win_rate': 0.0, 'num_closed_trades': 0
            }
        
        try:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
            performance = get_performance_stats()
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ…Ù† Ù†ÙˆØ¹ float
            if not isinstance(performance, dict):
                performance = {}
                
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ù†ÙˆØ¹ float Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ù€ __round__
            for key in ['win_rate', 'total_profit', 'total_loss', 'net_profit', 'net_profit_usdt']:
                if key in performance and performance[key] is not None:
                    try:
                        performance[key] = float(performance[key])
                    except (TypeError, ValueError):
                        performance[key] = 0.0
                        
        except Exception as perf_error:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡: {perf_error}")
            # Ù‚Ø§Ù…ÙˆØ³ ÙØ§Ø±Øº Ø¢Ù…Ù† ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£
            performance = {
                'total_trades': 0, 'open_trades': 0, 'closed_trades': 0,
                'profit_trades': 0, 'loss_trades': 0, 'win_rate': 0.0,
                'total_profit': 0.0, 'total_loss': 0.0, 'net_profit': 0.0, 'net_profit_usdt': 0.0
            }
        
        trades = []
            
        # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨
        current_year = datetime.now().year
        
        # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
        template = 'mobile_dashboard.html' if is_mobile else 'dashboard.html'
        
        logger.info(f"ØªÙ‚Ø¯ÙŠÙ… Ù‚Ø§Ù„Ø¨ {template} Ù…Ø¹ {len(watched_coins)} Ø¹Ù…Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø©")
        
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
        bot_status = get_bot_status()
        uptime_hours = 0
        uptime_minutes = 0
        
        if bot_status.get('running', False) and bot_status.get('start_time'):
            uptime = datetime.now() - bot_status.get('start_time')
            uptime_total_seconds = uptime.total_seconds()
            uptime_hours = uptime_total_seconds / 3600
            uptime_minutes = (uptime_total_seconds % 3600) / 60
        
        return render_template(
            template,
            trades=trades,
            performance=performance,
            capital=capital,
            base_currency=BASE_CURRENCY,
            bot_running=bot_status.get('running', False),
            watched_coins=watched_coins,
            current_year=current_year,
            uptime_hours=uptime_hours,
            uptime_minutes=uptime_minutes
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")
        # Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¨Ø³Ø·Ø© ÙˆØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡
        error_details = str(e) + " - " + traceback.format_exc()
        return f"Ø­Ø¯Ø« Ø®Ø·Ø£: {error_details}", 500

def get_trades_data():
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙÙ‚Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØµÙÙ‚Ø§Øª
    ØªÙ… ÙØµÙ„Ù‡Ø§ Ø¹Ù† route Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    """
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
    all_trades = load_json_data('active_trades.json', [])
    
    # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¥Ù„Ù‰ ØªÙˆØ§Ø±ÙŠØ® Ù…Ù‚Ø±ÙˆØ¡Ø©
    for trade in all_trades:
        # ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­
        timestamp = trade.get('timestamp')
        if timestamp:
            trade['opened_at'] = format_timestamp(timestamp)
        else:
            trade['opened_at'] = "ØºÙŠØ± Ù…ØªØ§Ø­"
            
        # ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_timestamp = trade.get('close_timestamp')
        if close_timestamp:
            trade['closed_at'] = format_timestamp(close_timestamp)
        else:
            trade['closed_at'] = "ØºÙŠØ± Ù…ØªØ§Ø­"
            
        # Ø¥Ø¶Ø§ÙØ© Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        if trade.get('status') == 'OPEN':
            symbol = trade.get('symbol')
            entry_price = trade.get('entry_price', 0)
            current_price = get_current_price(symbol)
            
            if entry_price and current_price:
                trade['current_profit_pct'] = ((current_price - entry_price) / entry_price) * 100
            else:
                trade['current_profit_pct'] = 0
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    stats = {
        'total_trades': len(all_trades),
        'open_trades': len([t for t in all_trades if t.get('status') == 'OPEN']),
        'closed_trades': len([t for t in all_trades if t.get('status') == 'CLOSED']),
        'profit_trades': 0,
        'loss_trades': 0,
        'win_rate': 0,
        'total_profit': 0.0,
        'total_loss': 0.0,
        'net_profit': 0.0
    }
    
    # Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© Ù…Ù† Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©
    total_profit_usdt = 0.0
    total_loss_usdt = 0.0
    
    for trade in all_trades:
        if trade.get('status') == 'CLOSED':
            profit_pct = trade.get('profit_pct', 0)
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©
            try:
                entry_price = float(trade.get('entry_price', trade.get('price', 0)))
                close_price = float(trade.get('close_price', 0))
                quantity = float(trade.get('quantity', 0))
                
                if entry_price > 0 and close_price > 0 and quantity > 0:
                    trade_value = entry_price * quantity
                    profit_loss_usdt = (close_price - entry_price) * quantity
                    
                    # Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    if profit_pct > 0:
                        total_profit_usdt += profit_loss_usdt
                    else:
                        total_loss_usdt += profit_loss_usdt
            except Exception as e:
                logger.warning(f"ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ù„Ù„ØµÙÙ‚Ø©: {e}")
            
            # Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
            if profit_pct > 0:
                stats['profit_trades'] += 1
                stats['total_profit'] += profit_pct
            else:
                stats['loss_trades'] += 1
                stats['total_loss'] += profit_pct
    
    # Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    if stats['closed_trades'] > 0:
        stats['win_rate'] = round((stats['profit_trades'] / stats['closed_trades']) * 100, 2)
    
    # Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙˆØ§Ù„Ø¯ÙˆÙ„Ø§Ø±
    stats['net_profit'] = stats['total_profit'] + stats['total_loss']
    stats['total_profit_usdt'] = round(total_profit_usdt, 2)
    stats['total_loss_usdt'] = round(total_loss_usdt, 2)
    stats['net_profit_usdt'] = round(total_profit_usdt + total_loss_usdt, 2)
    
    # ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    stats['total_profit'] = round(stats['total_profit'], 2)
    stats['total_loss'] = round(stats['total_loss'], 2)
    stats['net_profit'] = round(stats['net_profit'], 2)
    
    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
    try:
        bot_running = get_bot_status().get('running', False)
    except Exception as bot_error:
        logger.error(f"Error getting bot status: {bot_error}")
        bot_running = False
    
    return {
        'all_trades': all_trades,
        'stats': stats,
        'bot_running': bot_running
    }

@app.route('/trades')
def trades():
    """ØµÙØ­Ø© Ø§Ù„ØµÙÙ‚Ø§Øª"""
    try:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        trades_data = cache_page_data('trades')(get_trades_data)()
        
        current_year = datetime.now().year
        
        return render_template(
            'trades.html',
            all_trades=trades_data['all_trades'],
            stats=trades_data['stats'],
            current_year=current_year,
            bot_running=trades_data['bot_running']
        )
    except Exception as e:
        logger.error(f"Error in trades route: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", "danger")
        return render_template(
            'trades.html',
            all_trades=[],
            stats={
                'total_trades': 0, 'open_trades': 0, 'closed_trades': 0, 
                'profit_trades': 0, 'loss_trades': 0, 'win_rate': 0,
                'total_profit': 0.0, 'total_loss': 0.0, 'net_profit': 0.0
            },
            current_year=datetime.now().year,
            bot_running=False
        )

def get_settings_data():
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    ØªÙ… ÙØµÙ„Ù‡Ø§ Ø¹Ù† route Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    """
    # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    from app.config import ACTIVE_EXCHANGE, TOTAL_RISK_CAPITAL_RATIO
    
    # Ø¥Ø®ÙØ§Ø¡ Ø£Ø¬Ø²Ø§Ø¡ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª API Ø§Ù„Ø­Ø³Ø§Ø³Ø© - MEXC
    api_key_masked = API_KEY[:5] + "***" + API_KEY[-3:] if API_KEY else ""
    api_secret_masked = "********************" if API_SECRET else ""
    
    # Ø¥Ø®ÙØ§Ø¡ Ø£Ø¬Ø²Ø§Ø¡ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª API Ø§Ù„Ø­Ø³Ø§Ø³Ø© - Telegram
    telegram_token_masked = TELEGRAM_BOT_TOKEN[:5] + "***" + TELEGRAM_BOT_TOKEN[-3:] if TELEGRAM_BOT_TOKEN else ""
    
    config = {
        'BASE_CURRENCY': BASE_CURRENCY,
        'MAX_ACTIVE_TRADES': MAX_ACTIVE_TRADES,
        'TOTAL_RISK_CAPITAL_RATIO': TOTAL_RISK_CAPITAL_RATIO,
        'RISK_CAPITAL_RATIO': RISK_CAPITAL_RATIO,
        'TAKE_PROFIT': TAKE_PROFIT,
        'STOP_LOSS': STOP_LOSS,
        'TIME_STOP_LOSS_HOURS': TIME_STOP_LOSS_HOURS,
        'DAILY_LOSS_LIMIT': DAILY_LOSS_LIMIT,
        'MONITOR_INTERVAL_SECONDS': MONITOR_INTERVAL_SECONDS,
        'TELEGRAM_CHAT_ID': TELEGRAM_CHAT_ID
    }
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù…Ù† cache_dashboard_data
    bot_running = get_bot_status().get('running', False)
    
    return {
        'config': config,
        'active_exchange': ACTIVE_EXCHANGE,
        'api_key_masked': api_key_masked,
        'api_secret_masked': api_secret_masked,
        'telegram_token_masked': telegram_token_masked,
        'bot_running': bot_running
    }

@app.route('/settings', methods=['GET'])
def settings():
    """ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"""
    try:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        settings_data = cache_page_data('settings')(get_settings_data)()
        
        current_year = datetime.now().year
        
        return render_template(
            'settings.html',
            config=settings_data['config'],
            active_exchange=settings_data['active_exchange'],
            # MEXC API keys
            api_key_masked=settings_data['api_key_masked'],
            api_secret_masked=settings_data['api_secret_masked'],
            # Telegram settings
            telegram_token_masked=settings_data['telegram_token_masked'],
            current_year=current_year,
            bot_running=settings_data['bot_running']
        )
    except Exception as e:
        logger.error(f"Error in settings route: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", "danger")
        return render_template(
            'settings.html',
            config={},
            api_key_masked="",
            api_secret_masked="",
            telegram_token_masked="",
            current_year=datetime.now().year,
            bot_running=False
        )
        
@app.route('/reports')
def reports():
    """ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"""
    try:
        current_year = datetime.now().year
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        dashboard_data = get_dashboard_data()
        
        return render_template(
            'report.html',
            current_year=current_year,
            bot_running=dashboard_data.get('bot_running', False)
        )
    except Exception as e:
        logger.error(f"Error in reports route: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", "danger")
        return render_template(
            'report.html',
            current_year=datetime.now().year,
            bot_running=False
        )

@app.route('/generate_report', methods=['POST'])
def generate_report_route():
    """Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±ÙŠ"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        report_sent = generate_daily_report()
        if report_sent:
            return jsonify({"success": True})
        else:
            return jsonify({"success": False, "error": "ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"})
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {e}")
        return jsonify({"success": False, "error": str(e)})

@app.route('/update_report_settings', methods=['POST'])
def update_report_settings():
    """ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"""
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        report_hour = int(request.form.get('report_hour', 20))
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        start_daily_report_timer(target_hour=report_hour)
        
        flash("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!", "success")
        return redirect(url_for('reports'))
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}", "danger")
        return redirect(url_for('reports'))

@app.route('/api_settings', methods=['GET'])
def api_settings():
    """ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API"""
    try:
        # Ø¥Ø®ÙØ§Ø¡ Ø£Ø¬Ø²Ø§Ø¡ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª API Ø§Ù„Ø­Ø³Ø§Ø³Ø©
        api_key_masked = API_KEY[:5] + "***" + API_KEY[-3:] if API_KEY else ""
        api_secret_masked = "********************" if API_SECRET else ""
        
        current_year = datetime.now().year
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        dashboard_data = get_dashboard_data()
        
        return render_template(
            'api_settings.html',
            api_key_masked=api_key_masked,
            api_secret_masked=api_secret_masked,
            current_year=current_year,
            bot_running=dashboard_data.get('bot_running', False)
        )
    except Exception as e:
        logger.error(f"Error in api_settings route: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", "danger")
        return render_template(
            'api_settings.html',
            api_key_masked="",
            api_secret_masked="",
            current_year=datetime.now().year,
            bot_running=False
        )

@app.route('/save_settings', methods=['POST'])
def save_settings():
    """Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª"""
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        settings_data = {
            'max_active_trades': int(request.form.get('max_active_trades', MAX_ACTIVE_TRADES)),
            'total_risk_capital_ratio': float(request.form.get('total_risk_capital_ratio', TOTAL_RISK_CAPITAL_RATIO * 100)) / 100,
            'risk_capital_ratio': float(request.form.get('risk_capital_ratio', RISK_CAPITAL_RATIO * 100)) / 100,
            'take_profit': float(request.form.get('take_profit', TAKE_PROFIT * 100)) / 100,
            'stop_loss': float(request.form.get('stop_loss', STOP_LOSS * 100)) / 100,
            'time_stop_loss_hours': int(request.form.get('time_stop_loss_hours', TIME_STOP_LOSS_HOURS)),
            'daily_loss_limit': float(request.form.get('daily_loss_limit', DAILY_LOSS_LIMIT * 100)) / 100,
            'monitor_interval': int(request.form.get('monitor_interval', MONITOR_INTERVAL_SECONDS)),
            'telegram_chat_id': request.form.get('telegram_chat_id', TELEGRAM_CHAT_ID),
            'enable_notifications': 'enable_notifications' in request.form
        }
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ API Ù„Ù…Ù†ØµØ© MEXC
        mexc_api_key = request.form.get('api_key', '').strip()
        mexc_api_secret = request.form.get('api_secret', '').strip()
        
        # ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ MEXC Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
        if mexc_api_key and mexc_api_secret:
            from app.config import update_api_keys
            keys_updated = update_api_keys(mexc_api_key, mexc_api_secret)
            if keys_updated:
                flash("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ MEXC API Ø¨Ù†Ø¬Ø§Ø­", "success")
            else:
                flash("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ MEXC API", "warning")
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
        bot_running = get_bot_status().get('running', False)
        if bot_running:
            stop_bot()
            import time
            time.sleep(1)  # Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø© Ù„Ø¶Ù…Ø§Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
            start_bot()
            flash("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!", "success")
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
        import sys
        import importlib
        modules_to_reload = ['app.mexc_api', 'app.exchange_manager']
        for module_name in modules_to_reload:
            if module_name in sys.modules:
                importlib.reload(sys.modules[module_name])
                logger.info(f"ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØ­Ø¯Ø© {module_name} Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ø°Ø§ Ø³ÙŠÙƒØªØ¨ Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
        flash("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", "success")
        return redirect(url_for('settings'))
    except Exception as e:
        logger.error(f"Error saving settings: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}", "danger")
        return redirect(url_for('settings'))
        
@app.route('/save_api_settings', methods=['POST'])
def save_api_settings():
    """Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API"""
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        api_key = request.form.get('api_key', '').strip()
        api_secret = request.form.get('api_secret', '').strip()
        
        logger.info(f"Received new API key: {api_key[:3]}...{api_key[-3:] if len(api_key) > 6 else ''}")
        
        if not api_key or not api_secret:
            flash("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API ÙˆØ³Ø± API Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "danger")
            return redirect(url_for('api_settings'))
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        if len(api_key) < 10 or len(api_secret) < 10:
            flash("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØ§ØªÙŠØ­ API ÙƒØ§Ù…Ù„Ø© ÙˆØ¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­", "warning")
            return redirect(url_for('api_settings'))
            
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙÙŠ config.py Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        from app.config import update_api_keys
        update_success = update_api_keys(api_key, api_secret)
        
        if not update_success:
            flash("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ API. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "danger")
            return redirect(url_for('api_settings'))
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
        bot_running = get_bot_status().get('running', False)
        if bot_running:
            stop_bot()
            import time  # Ø¥Ø¶Ø§ÙØ© import Ù‡Ù†Ø§
            time.sleep(1)  # Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø© Ù„Ø¶Ù…Ø§Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
            start_bot()
            flash("ØªÙ… Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª!", "success")
        else:
            flash("ØªÙ… Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API Ø¨Ù†Ø¬Ø§Ø­!", "success")
            
        logger.info(f"API keys updated successfully. Key: {api_key[:3]}...{api_key[-3:]}")
        logger.info("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ API ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§ØªØµØ§Ù„ API Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
        import sys
        import importlib
        if 'app.mexc_api' in sys.modules:
            importlib.reload(sys.modules['app.mexc_api'])
        
        return redirect(url_for('home'))
    except Exception as e:
        logger.error(f"Error saving API settings: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API: {e}", "danger")
        return redirect(url_for('api_settings'))

@app.route('/start', methods=['POST'])
def start():
    """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    try:
        logger.info("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯Ø§Ù„Ø©
        from app.trading_bot import start_bot, get_bot_status, BOT_STATUS
        
        # ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        bot_status_before = get_bot_status().get('running', False)
        logger.info(f"Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: {bot_status_before}, BOT_STATUS={BOT_STATUS}")
        
        if start_bot():
            # ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            bot_status_after = get_bot_status().get('running', False)
            logger.info(f"ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª! Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„: {bot_status_after}, BOT_STATUS={BOT_STATUS}")
            flash("ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­!", "success")
        else:
            logger.warning("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.")
            flash("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.", "warning")
        
        return redirect(url_for('home'))
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
        logger.error(traceback.format_exc())  # ØªØ³Ø¬ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙƒØ§Ù…Ù„Ø©
        flash(f"ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}", "danger")
        return redirect(url_for('home'))

@app.route('/stop', methods=['POST'])
def stop():
    """Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª"""
    try:
        logger.info("Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯Ø§Ù„Ø©
        from app.trading_bot import stop_bot, get_bot_status
        
        # ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        bot_status_before = get_bot_status().get('running', False)
        logger.info(f"Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: {bot_status_before}")
        
        if stop_bot():
            logger.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
            flash("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­!", "success")
        else:
            logger.warning("Ø§Ù„Ø¨ÙˆØª Ù…ØªÙˆÙ‚Ù Ø¨Ø§Ù„ÙØ¹Ù„.")
            flash("Ø§Ù„Ø¨ÙˆØª Ù…ØªÙˆÙ‚Ù Ø¨Ø§Ù„ÙØ¹Ù„.", "warning")
            
        # ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        bot_status_after = get_bot_status().get('running', False)
        logger.info(f"Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: {bot_status_after}")
        
        return redirect(url_for('home'))
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª: {e}")
        logger.error(traceback.format_exc())  # ØªØ³Ø¬ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙƒØ§Ù…Ù„Ø©
        flash(f"ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª: {e}", "danger")
        return redirect(url_for('home'))

def get_watched_coins_data():
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    ØªÙ… ÙØµÙ„Ù‡Ø§ Ø¹Ù† route Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    """
    # Ø¨Ø¯Ø¡ ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
    if not get_watched_symbols():
        start_market_scanner(interval=300)  # ÙØ­Øµ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙØ±Øµ Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    opportunities = get_trading_opportunities()
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    watched_coins = get_watched_symbols()
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† ÙƒÙ„ Ø¹Ù…Ù„Ø©
    coin_data = []
    for symbol in watched_coins:
        try:
            current_price = get_current_price(symbol)
            
            # Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Øµ
            opportunity = next((opp for opp in opportunities if opp['symbol'] == symbol), None)
            
            if opportunity:
                coin_data.append({
                    'symbol': symbol,
                    'current_price': current_price,
                    'trend': opportunity.get('trend', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'),
                    'potential_profit': opportunity.get('potential_profit', 0),
                    'reason': opportunity.get('reason', ''),
                    'volume_24h': opportunity.get('volume_24h', 0),
                    'change_24h': opportunity.get('change_24h', 0),
                    'rsi': opportunity.get('analysis', {}).get('rsi', 0)
                })
        except Exception as e:
            logger.error(f"Error getting data for {symbol}: {e}")
    
    # ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
    sorted_coins = sorted(coin_data, key=lambda x: x['potential_profit'], reverse=True)
    
    # Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
    bot_running = get_bot_status().get('running', False)
    
    return {
        'coins': sorted_coins,
        'bot_running': bot_running
    }

@app.route('/watched_coins')
def watched_coins():
    """ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©"""
    try:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        coins_data = cache_page_data('watched_coins')(get_watched_coins_data)()
        
        current_year = datetime.now().year
        return render_template(
            'watched_coins.html',
            coins=coins_data['coins'],
            current_year=current_year,
            bot_running=coins_data['bot_running']
        )
    except Exception as e:
        logger.error(f"Error in watched_coins route: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", "danger")
        return render_template(
            'watched_coins.html',
            coins=[],
            current_year=datetime.now().year,
            bot_running=False
        )

@app.route('/scan_market', methods=['POST'])
def scan_market_route():
    """ØªØ´ØºÙŠÙ„ ÙØ­Øµ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø³ÙˆÙ‚"""
    try:
        # ØªÙ†ÙÙŠØ° ÙØ­Øµ ÙÙˆØ±ÙŠ
        opportunities = scan_market()
        
        if opportunities:
            flash(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(opportunities)} ÙØ±ØµØ© Ù„Ù„ØªØ¯Ø§ÙˆÙ„", "success")
        else:
            flash("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ±Øµ ØªØ¯Ø§ÙˆÙ„ Ù…Ù†Ø§Ø³Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ", "warning")
            
        return redirect(url_for('watched_coins'))
    except Exception as e:
        logger.error(f"Error in scan_market route: {e}")
        flash(f"ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø³ÙˆÙ‚: {e}", "danger")
        return redirect(url_for('watched_coins'))

@app.route('/start_scanner', methods=['POST'])
def start_scanner():
    """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚"""
    try:
        interval = int(request.form.get('interval', 300))
        start_market_scanner(interval=interval)
        flash(f"ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚ (ÙØªØ±Ø© Ø§Ù„ÙØ­Øµ: {interval} Ø«Ø§Ù†ÙŠØ©)", "success")
        return redirect(url_for('watched_coins'))
    except Exception as e:
        logger.error(f"Error starting market scanner: {e}")
        flash(f"ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚: {e}", "danger")
        return redirect(url_for('watched_coins'))

@app.route('/stop_scanner', methods=['POST'])
def stop_scanner():
    """Ø¥ÙŠÙ‚Ø§Ù ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚"""
    try:
        stop_market_scanner()
        flash("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚", "success")
        return redirect(url_for('watched_coins'))
    except Exception as e:
        logger.error(f"Error stopping market scanner: {e}")
        flash(f"ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù ÙØ§Ø­Øµ Ø§Ù„Ø³ÙˆÙ‚: {e}", "danger")
        return redirect(url_for('watched_coins'))

@app.route('/coin_details/<symbol>')
def coin_details(symbol):
    """ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©"""
    try:
        # Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙØµÙ„ Ù„Ù„Ø¹Ù…Ù„Ø©
        coin = get_symbol_analysis(symbol)
        
        # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        klines = get_klines(symbol, interval='15m', limit=48)  # 12 Ø³Ø§Ø¹Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        chart_data = []
        if klines:
            for kline in klines:
                chart_data.append({
                    'time': kline.get('open_time'),
                    'open': kline.get('open'),
                    'high': kline.get('high'),
                    'low': kline.get('low'),
                    'close': kline.get('close'),
                    'volume': kline.get('volume')
                })
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if 'error' in coin:
            flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©: {coin['error']}", "danger")
            return redirect(url_for('watched_coins'))
        
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ analysis
        if 'analysis' not in coin:
            coin['analysis'] = {
                'rsi': 50,
                'ema_status': 'ØºÙŠØ± Ù…ØªØ§Ø­',
                'volatility': 0
            }
        
        current_year = datetime.now().year
        return render_template(
            'coin_details.html',
            coin=coin,
            chart_data=chart_data,
            current_year=current_year,
            bot_running=get_bot_status().get('running', False)
        )
    except Exception as e:
        logger.error(f"Error in coin_details route for {symbol}: {e}")
        flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© {symbol}: {e}", "danger")
        return redirect(url_for('watched_coins'))

@app.route('/api/watched_coins')
def api_watched_coins():
    """ÙˆØ§Ø¬Ù‡Ø© API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©"""
    try:
        opportunities = get_trading_opportunities()
        return jsonify({
            'status': 'success',
            'data': opportunities
        })
    except Exception as e:
        logger.error(f"Error in api_watched_coins: {e}")
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/test_api_permissions', methods=['GET'])
def api_test_permissions():
    """ÙˆØ§Ø¬Ù‡Ø© API Ù„Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ§Øª API"""
    try:
        from app.mexc_api import test_api_permissions
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        permissions = test_api_permissions()
        
        return jsonify({
            'status': 'success',
            'data': permissions
        })
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ§Øª API: {e}")
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/clean_fake_trades', methods=['POST'])
def api_clean_fake_trades():
    """ÙˆØ§Ø¬Ù‡Ø© API Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©"""
    try:
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        result = clean_all_fake_trades()
        
        logger.info(f"ğŸ§¹ ØªÙ… ØªÙ†ÙÙŠØ° ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©: {result}")
        
        return jsonify({
            'status': 'success',
            'message': f"ØªÙ… ØªÙ†Ø¸ÙŠÙ {result.get('cleaned_count', 0)} ØµÙÙ‚Ø© ÙˆÙ‡Ù…ÙŠØ© Ù…Ù† Ø£ØµÙ„ {result.get('original_count', 0)} ØµÙÙ‚Ø©",
            'data': result
        })
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©: {e}")
        import traceback
        logger.error(traceback.format_exc())
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/execute_trade', methods=['POST'])
def api_execute_trade():
    """ÙˆØ§Ø¬Ù‡Ø© API Ù„ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ØªØ¯Ø§ÙˆÙ„"""
    try:
        data = request.json
        if not data:
            return jsonify({
                'status': 'error',
                'message': 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©'
            }), 400
            
        symbol = data.get('symbol')
        if not symbol:
            return jsonify({
                'status': 'error',
                'message': 'Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ù…Ø·Ù„ÙˆØ¨'
            }), 400
            
        # ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©
        from app.trade_executor import execute_trade
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­
        from app.capital_manager import get_position_size
        quantity = get_position_size(symbol)
        
        success = execute_trade(symbol, quantity)
        
        if success:
            return jsonify({
                'status': 'success',
                'message': f'ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø© Ø¹Ù„Ù‰ {symbol} Ø¨Ù†Ø¬Ø§Ø­'
            })
        else:
            return jsonify({
                'status': 'error',
                'message': f'ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø© Ø¹Ù„Ù‰ {symbol}'
            }), 500
    except Exception as e:
        logger.error(f"Error in api_execute_trade: {e}")
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/test_trade', methods=['GET', 'POST'])
def test_trade():
    """Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©"""
    if request.method == 'POST':
        try:
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            symbol = request.form.get('symbol', 'BTCUSDT')
            quantity = float(request.form.get('quantity', '0.0001'))
            trade_type = request.form.get('trade_type', 'BUY')  # Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø© (BUY/SELL)
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            logger.info(f"â­â­â­ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªØ¨Ø§Ø± ØµÙÙ‚Ø©: {trade_type} {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity} â­â­â­")
            
            result = None
            
            # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø©
            if trade_type == 'SELL':
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† trade_logic
                from app.trade_logic import close_trade
                
                # ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ«Ù Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
                logger.info(f"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© close_trade Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù€ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity}")
                
                success = close_trade(symbol, quantity)
                
                if success:
                    result = {
                        'success': True,
                        'test_details': {
                            'order_id': 'test_sell_' + str(int(time.time())),
                            'symbol': symbol,
                            'quantity': quantity,
                            'type': 'SELL',
                            'message': 'ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­'
                        }
                    }
                    logger.info(f"âœ… ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ {symbol}")
                    flash(f"ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity}", "success")
                else:
                    result = {
                        'success': False,
                        'error': f'ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¹Ù„Ù‰ {symbol}'
                    }
                    logger.error(f"âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù€ {symbol}")
                    flash(f"ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù€ {symbol}", "danger")
            else:
                # ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø´Ø±Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                from app.exchange_manager import place_order
                
                # ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ«Ù Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
                logger.info(f"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© place_order Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù€ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity}")
                
                order_result = place_order(symbol, "BUY", quantity, order_type="MARKET")
                
                if order_result:
                    result = {
                        'success': True,
                        'test_details': {
                            'order_id': order_result.get('orderId', 'unknown'),
                            'symbol': symbol,
                            'quantity': quantity,
                            'type': 'BUY',
                            'message': 'ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­',
                            'full_response': order_result
                        }
                    }
                    logger.info(f"âœ… ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­: {order_result}")
                    flash(f"ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø¹Ø±Ù Ø§Ù„Ø£Ù…Ø±: {order_result.get('orderId', 'unknown')}", "success")
                else:
                    result = {
                        'success': False,
                        'error': f'ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù„Ù‰ {symbol}'
                    }
                    logger.error(f"âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡")
                    flash(f"ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù„Ù‰ {symbol}", "danger")
                
            return render_template(
                'test_trade.html',
                result=result,
                symbol=symbol,
                quantity=quantity,
                trade_type=trade_type,
                current_year=datetime.now().year
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙÙ‚Ø©: {e}")
            import traceback
            logger.error(traceback.format_exc())
            flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: {e}", "danger")
    
    # Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    return render_template(
        'test_trade.html',
        result=None,
        symbol="BTCUSDT",
        quantity=0.0001,
        trade_type="BUY",
        current_year=datetime.now().year
    )
    
@app.route('/test_sell', methods=['GET', 'POST'])
def test_sell():
    """Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø®ØµØµ Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨ÙŠØ¹ ÙÙ‚Ø·"""
    import traceback  # Ø§Ø³ØªÙŠØ±Ø§Ø¯ traceback Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø©
    
    if request.method == 'POST':
        try:
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            symbol = request.form.get('symbol', 'BTCUSDT')
            quantity = float(request.form.get('quantity', '0.0001'))
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            logger.info(f"â­â­â­ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø®ØµØµ Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨ÙŠØ¹ - Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙŠØ¹ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity} â­â­â­")
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† trade_logic
            from app.trade_logic import close_trade
            
            # ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ«Ù Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
            logger.info(f"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© close_trade Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù€ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity}")
            
            # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙƒÙ„ ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ù†ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ¹
            account_balance = None
            current_price = None
            place_order_result = None
            close_trade_result = None
            
            # ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ¹
            try:
                from app.exchange_manager import get_account_balance, get_current_price
                account_balance = get_account_balance()
                current_price = get_current_price(symbol)
                logger.info(f"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ¹ - Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨: {account_balance}, Ø³Ø¹Ø± {symbol}: {current_price}")
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨: {e}")
                logger.error(traceback.format_exc())
            
            # ØªØ¬Ø±Ø¨Ø© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨ÙŠØ¹
            try:
                # ØªÙ†ÙÙŠØ° ÙÙ‚Ø· place_order
                from app.exchange_manager import place_order
                logger.info(f"Ø§Ø®ØªØ¨Ø§Ø± place_order Ù…Ø¨Ø§Ø´Ø±Ø©")
                place_order_result = place_order(symbol, "SELL", quantity, order_type="MARKET")
                logger.info(f"Ù†ØªÙŠØ¬Ø© place_order: {place_order_result}")
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ ÙˆØ¸ÙŠÙØ© place_order: {e}")
                logger.error(traceback.format_exc())
            
            # ØªØ¬Ø±Ø¨Ø© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            try:
                logger.info(f"Ø§Ø®ØªØ¨Ø§Ø± close_trade")
                close_trade_result = close_trade(symbol, quantity)
                logger.info(f"Ù†ØªÙŠØ¬Ø© close_trade: {close_trade_result}")
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ ÙˆØ¸ÙŠÙØ© close_trade: {e}")
                logger.error(traceback.format_exc())
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹
            try:
                from app.exchange_manager import get_account_balance  # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ù„ØªØ£ÙƒØ¯
                account_balance_after = get_account_balance()
                logger.info(f"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹ - Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨: {account_balance_after}")
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹: {e}")
                logger.error(traceback.format_exc())
            
            if close_trade_result:
                flash(f"ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ {symbol} Ø¨ÙƒÙ…ÙŠØ© {quantity}", "success")
            else:
                flash(f"ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù€ {symbol}", "danger")
            
            return render_template(
                'test_sell.html',
                symbol=symbol,
                quantity=quantity,
                account_balance=account_balance,
                current_price=current_price,
                place_order_result=place_order_result,
                close_trade_result=close_trade_result,
                current_year=datetime.now().year
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ¹: {e}")
            logger.error(traceback.format_exc())
            flash(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ¹: {e}", "danger")
    
    # Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ¹
    return render_template(
        'test_sell.html',
        symbol="BTCUSDT",
        quantity=0.0001,
        account_balance=None,
        current_price=None,
        place_order_result=None,
        close_trade_result=None,
        current_year=datetime.now().year
    )

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
from app.watchdog import start_watchdog, send_ping_to_prevent_sleep

# ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø°ÙŠ ÙŠØ±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙˆØª
# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† decorator Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
def start_all_background_tasks():
    """ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
    logger.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©...")
    
    # ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
    start_watchdog()
    logger.info("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù† ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙˆØª")
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆÙ†
    def keep_alive_task():
        """Ù…Ù‡Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆÙ…Ù†Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆÙ†"""
        while True:
            try:
                # Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù…Ù†Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆÙ† ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
                send_ping_to_prevent_sleep()
                time.sleep(600)  # 10 Ø¯Ù‚Ø§Ø¦Ù‚
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ù‡Ù…Ø© Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
                time.sleep(60)  # Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    
    # ØªØ´ØºÙŠÙ„ Ù…Ù‡Ù…Ø© Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…
    keep_alive_thread = threading.Thread(target=keep_alive_task, daemon=True)
    keep_alive_thread.start()
    logger.info("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø¢Ù„ÙŠØ© Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø®Ø§Ø¯Ù…")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
start_all_background_tasks()

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=True)
